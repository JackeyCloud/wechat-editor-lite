<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大骏编辑器</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- 基础样式 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif; color: rgb(58, 58, 58); }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(217, 119, 6, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(217, 119, 6, 0.4); }
        
        .main-container { display: flex; height: 100vh; }
        
        /* 左侧大纲 */
        .outline-panel { width: 260px; background: rgb(248, 245, 240); border-right: 1px solid rgba(0,0,0,0.06); padding: 24px 16px; overflow-y: auto; flex-shrink: 0; }
        .panel-title { font-size: 11px; font-weight: 600; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .outline-list { list-style: none; }
        .outline-item { padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; font-size: 14px; color: #57534e; line-height: 1.5; transition: all 0.15s; border-left: 2px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .outline-item:hover { background: rgba(255,255,255,0.6); color: #292524; border-left-color: rgb(227, 164, 63); padding-left: 14px; }
        .outline-item.active { background: rgba(227, 164, 63, 0.15); color: #b06d22; border-left-color: rgb(227, 164, 63); font-weight: 500; }
        .outline-empty { font-size: 13px; color: #a8a29e; font-style: italic; text-align: center; padding: 40px 0; line-height: 1.6; }
        
        /* 编辑区布局 */
        .editor-section { flex: 1; display: flex; flex-direction: column; background: rgb(253, 252, 250); position: relative; }
        
        /* 工具栏 */
        .editor-toolbar { height: 56px; background: rgba(253, 252, 250, 0.98); border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0; position: sticky; top: 0; z-index: 50; }
        .toolbar-left { display: flex; gap: 4px; }
        .tool-btn { width: 36px; height: 36px; border: none; background: transparent; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #78716c; transition: all 0.2s; }
        .tool-btn:hover { background: rgba(0,0,0,0.04); color: #d97706; transform: translateY(-1px); }
        .tool-btn.red:hover { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .toolbar-right { display: flex; gap: 8px; }
        .btn-copy { background: #292524; color: white; padding: 8px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-copy:hover { background: #44403c; transform: translateY(-1px); }
        
        /* 核心滚动容器 - Block布局 + 底部留白 */
        .editor-wrapper { flex: 1; overflow-y: auto; display: block; padding: 40px 20px 0; position: relative; }
        
        /* 编辑器本体 */
        #editor { width: 100%; max-width: 680px; min-height: 100%; margin: 0 auto; background-color: rgb(253, 252, 250); color: rgb(58, 58, 58); font-size: 17px; line-height: 30px; letter-spacing: 0.3px; outline: none; cursor: text; padding-bottom: 50vh; }
        
        /* 段落与间距 */
        #editor p { margin: 0 0 20px 0; min-height: 30px; line-height: 30px; }
        #editor div { line-height: 30px; margin-bottom: 20px; }
        
        /* 标题样式 - H2作为小标题 */
        #editor h1, #editor h2, #editor h3, #editor h4, #editor h5, #editor h6 { margin: 0 0 20px 0; font-family: "Playfair Display", "Noto Serif SC", Georgia, serif; font-weight: 700; color: rgb(10, 10, 10); letter-spacing: -0.3px; line-height: 30px; min-height: 30px; }
        #editor h1 { font-size: 24px; } #editor h2 { font-size: 22px; } #editor h3 { font-size: 20px; } 
        #editor h4 { font-size: 18px; font-weight: 600; }
        
        /* 其他排版元素 */
        #editor strong, #editor b { font-weight: 600; color: rgb(10, 10, 10); }
        #editor img { max-width: 100%; width: 100%; height: auto; display: block; margin: 20px 0; border-radius: 4px; vertical-align: bottom; }
        #editor blockquote { margin: 0 0 20px 0; padding: 15px 20px; border-left: 3px solid rgb(227, 164, 63); background: rgba(227, 164, 63, 0.05); font-style: italic; color: rgb(88, 88, 88); line-height: 30px; font-size: 17px; min-height: 30px; }
        #editor ul, #editor ol { margin: 0 0 20px 0; padding-left: 24px; line-height: 30px; }
        #editor li { margin-bottom: 8px; line-height: 30px; min-height: 30px; }
        #editor hr { border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 30px 0; height: 0; }
        
        /* 右侧预览区 */
        .preview-panel { width: 415px; background: rgb(255, 254, 252); border-left: 1px solid rgba(0,0,0,0.06); padding: 24px 20px; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
        .preview-title { font-size: 11px; font-weight: 600; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); width: 100%; text-align: center; position: sticky; top: 0; background: rgb(255, 254, 252); z-index: 10; }
        .mobile-viewport { width: 375px; max-height: calc(100vh - 150px); background: rgb(253, 252, 250); box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 4px; overflow-y: auto; }
        .preview-content { width: 100%; padding: 20px 16px; color: rgb(58, 58, 58); font-size: 15px; line-height: 30px; letter-spacing: 0.3px; padding-bottom: 100px; }
        
        /* 预览样式复刻 */
        .preview-content p, .preview-content div { margin: 0 0 20px 0; line-height: 30px; min-height: 30px; }
        .preview-content h1, .preview-content h2, .preview-content h3 { margin: 0 0 20px 0; font-family: "Playfair Display", "Noto Serif SC", Georgia, serif; font-weight: 700; color: rgb(10, 10, 10); letter-spacing: -0.3px; line-height: 30px; min-height: 30px; }
        .preview-content h1 { font-size: 22px; } .preview-content h2 { font-size: 20px; }
        .preview-content strong, .preview-content b { font-weight: 600; color: rgb(10, 10, 10); }
        .preview-content img { max-width: 100%; width: 100%; height: auto; display: block; margin: 20px 0; border-radius: 4px; }
        .preview-content blockquote { margin: 0 0 20px 0; padding: 15px; border-left: 3px solid rgb(227, 164, 63); background: rgba(227, 164, 63, 0.05); font-style: italic; color: rgb(88, 88, 88); line-height: 30px; font-size: 15px; min-height: 30px; }
        .preview-content ul, .preview-content ol { margin: 0 0 20px 0; padding-left: 20px; line-height: 30px; }
        .preview-content li { margin-bottom: 8px; line-height: 30px; min-height: 30px; }

        /* 斜杠菜单样式 */
        .slash-menu {
            position: absolute;
            width: 180px;
            background: rgb(255, 255, 255);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.06);
            padding: 6px;
            display: none;
            z-index: 1000;
            font-family: Inter, -apple-system, sans-serif;
        }
        .slash-menu.active { display: block; animation: fadeIn 0.15s ease-out; }
        .slash-item { padding: 8px 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-radius: 6px; font-size: 14px; color: #57534e; transition: all 0.1s; }
        .slash-item:hover, .slash-item.selected { background: rgba(227, 164, 63, 0.1); color: #b45309; }
        .slash-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: #a8a29e; }
        .slash-item:hover .slash-icon, .slash-item.selected .slash-icon { color: #d97706; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 弹窗与提示 */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: rgb(253, 252, 250); padding: 32px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); max-width: 400px; width: 90%; text-align: center; border: 1px solid rgba(0,0,0,0.06); transform: translateY(20px); transition: transform 0.3s; }
        .modal-overlay.show .modal-content { transform: translateY(0); }
        .modal-title { font-size: 18px; font-weight: 600; color: #292524; margin-bottom: 12px; font-family: "Playfair Display", "Noto Serif SC", Georgia, serif; }
        .modal-text { font-size: 15px; color: #78716c; line-height: 1.6; margin-bottom: 24px; }
        .modal-buttons { display: flex; gap: 12px; justify-content: center; }
        .modal-btn { padding: 10px 24px; border-radius: 8px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .modal-btn-cancel { background: rgba(0,0,0,0.05); color: #57534e; }
        .modal-btn-cancel:hover { background: rgba(0,0,0,0.1); }
        .modal-btn-confirm { background: #dc2626; color: white; }
        .modal-btn-confirm:hover { background: #b91c1c; }
        .info { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #a8a29e; background: rgba(253, 252, 250, 0.95); padding: 6px 16px; border-radius: 20px; pointer-events: none; opacity: 0.8; border: 1px solid rgba(0,0,0,0.06); z-index: 50; }
        .toast { position: fixed; top: 72px; right: 24px; background: #292524; color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; opacity: 0; transform: translateY(-10px); transition: all 0.3s; z-index: 200; }
        .toast.show { opacity: 1; transform: translateY(0); }
        @media (max-width: 1400px) { .preview-panel { display: none; } }
        @media (max-width: 1100px) { .outline-panel { display: none; } }
    </style>
</head>
<body>

    <div class="main-container">
        <aside class="outline-panel">
            <div class="panel-title">文章大纲</div>
            <ul class="outline-list" id="outlineList">
                <li class="outline-empty">暂无小标题<br>点击工具栏添加</li>
            </ul>
        </aside>

        <section class="editor-section">
            <div class="editor-toolbar">
                <div class="toolbar-left">
                    <button class="tool-btn" onclick="insert('heading')" title="小标题 (H2)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 12h12M6 12v6m0-6V6m12 6v6m0-6V6"/></svg>
                    </button>
                    <button class="tool-btn" onclick="insert('quote')" title="引用">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg>
                    </button>
                    <button class="tool-btn" onclick="insert('list')" title="列表">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    </button>
                    <div style="width: 1px; height: 20px; background: rgba(0,0,0,0.08); margin: 0 6px;"></div>
                    <button class="tool-btn" onclick="insert('image')" title="图片">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    </button>
                    <button class="tool-btn" onclick="insert('divider')" title="分割线">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <div style="width: 1px; height: 20px; background: rgba(0,0,0,0.08); margin: 0 6px;"></div>
                    <button class="tool-btn red" onclick="showClearModal()" title="清空">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                <div class="toolbar-right">
                    <button class="btn-copy" onclick="copyToWechat()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        复制到公众号
                    </button>
                </div>
            </div>

            <div class="editor-wrapper" id="editorWrapper">
                <div id="editor" contenteditable="true" onpaste="handlePaste(event)" oninput="onEditorInput()"></div>
            </div>
        </section>

        <aside class="preview-panel">
            <div class="preview-title">手机预览</div>
            <div class="mobile-viewport" id="mobileViewport">
                <div class="preview-content" id="previewContent"></div>
            </div>
        </aside>
    </div>

    <div class="modal-overlay" id="clearModal" onclick="hideClearModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">清空内容</div>
            <div class="modal-text">确定要清空所有内容吗？此操作不可恢复。</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="hideClearModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmClear()">确认清空</button>
            </div>
        </div>
    </div>

    <div id="slashMenu" class="slash-menu">
        <div class="slash-item selected" data-cmd="heading">
            <div class="slash-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 12h12M6 12v6m0-6V6m12 6v6m0-6V6"/></svg></div>
            小标题
        </div>
        <div class="slash-item" data-cmd="quote">
            <div class="slash-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg></div>
            引用
        </div>
        <div class="slash-item" data-cmd="list">
            <div class="slash-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></div>
            列表
        </div>
        <div class="slash-item" data-cmd="divider">
            <div class="slash-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
            分割线
        </div>
        <div class="slash-item" data-cmd="image">
            <div class="slash-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>
            图片
        </div>
    </div>

    <div class="info" id="stats">0 字 · 0 图</div>
    <div class="toast" id="toast">已复制</div>
    <input type="file" id="fileInput" multiple accept="image/*" hidden onchange="handleFiles(this.files)">

    <script>
        const editor = document.getElementById('editor');
        const editorWrapper = document.getElementById('editorWrapper');
        const outlineList = document.getElementById('outlineList');
        const previewContent = document.getElementById('previewContent');
        const mobileViewport = document.getElementById('mobileViewport');
        const toast = document.getElementById('toast');
        const stats = document.getElementById('stats');
        const clearModal = document.getElementById('clearModal');
        
        // Slash Menu
        const slashMenu = document.getElementById('slashMenu');
        const slashItems = document.querySelectorAll('.slash-item');
        let slashActiveIndex = 0;
        let isSlashMenuOpen = false;
        
        let currentHeadings = [];
        let isSyncing = false;

        window.addEventListener('load', () => {
            editor.focus();
            const saved = localStorage.getItem('sun_editor_draft');
            if (saved) {
                editor.innerHTML = saved;
                updateAll();
            }
            setupIntersectionObserver();
            editorWrapper.addEventListener('scroll', () => {
                syncPreviewScroll();
                if (isSlashMenuOpen) closeSlashMenu();
            });
            
            // 菜单点击事件
            slashItems.forEach((item, index) => {
                item.addEventListener('click', () => {
                    executeSlashCommand(item.dataset.cmd);
                });
                item.addEventListener('mouseenter', () => updateSlashSelection(index));
            });
        });

        // 键盘与输入监听
        editor.addEventListener('keydown', (e) => {
            if (isSlashMenuOpen) {
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    updateSlashSelection(slashActiveIndex - 1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    updateSlashSelection(slashActiveIndex + 1);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const cmd = slashItems[slashActiveIndex].dataset.cmd;
                    executeSlashCommand(cmd);
                } else if (e.key === 'Escape') {
                    closeSlashMenu();
                }
            }
        });

        editor.addEventListener('keyup', (e) => {
            if (e.key === '/') {
                // 仅在空行或段落内容仅为 "/" 时触发
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const range = selection.getRangeAt(0);
                
                // 获取当前块级元素
                let block = range.startContainer;
                if (block.nodeType === 3) block = block.parentNode;
                
                if (block && (block.tagName === 'P' || block.tagName === 'DIV' || block.tagName === 'LI')) {
                    const text = block.textContent.trim();
                    if (text === '/') {
                        openSlashMenu(range);
                    }
                }
            } else if (isSlashMenuOpen && e.key !== 'ArrowUp' && e.key !== 'ArrowDown' && e.key !== 'Enter') {
                const selection = window.getSelection();
                const node = selection.anchorNode;
                // 如果用户删除了斜杠或输入了其他字符，关闭菜单
                if (node && !node.textContent.includes('/')) {
                    closeSlashMenu();
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (isSlashMenuOpen && !slashMenu.contains(e.target)) {
                closeSlashMenu();
            }
        });

        function openSlashMenu(range) {
            isSlashMenuOpen = true;
            slashActiveIndex = 0;
            updateSlashSelection(0);
            const rect = range.getBoundingClientRect();
            const top = rect.bottom + window.scrollY + 5;
            const left = rect.left + window.scrollX;
            slashMenu.style.top = `${top}px`;
            slashMenu.style.left = `${left}px`;
            slashMenu.classList.add('active');
        }

        function closeSlashMenu() {
            isSlashMenuOpen = false;
            slashMenu.classList.remove('active');
        }

        function updateSlashSelection(index) {
            if (index < 0) index = slashItems.length - 1;
            if (index >= slashItems.length) index = 0;
            slashActiveIndex = index;
            slashItems.forEach((item, i) => {
                if (i === index) item.classList.add('selected');
                else item.classList.remove('selected');
            });
        }

        // --- 核心修复：斜杠命令执行 ---
        function executeSlashCommand(cmd) {
            // 1. 精确选中并删除 "/" 符号
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let container = range.startContainer;
                
                // 找到包含 / 的文本节点
                if (container.nodeType !== 3) {
                     // 如果选区在元素上，尝试找里面的文本节点
                     if (container.childNodes.length > 0) container = container.childNodes[0];
                }
                
                if (container.nodeType === 3) {
                    const text = container.textContent;
                    const slashIdx = text.lastIndexOf('/');
                    if (slashIdx !== -1) {
                        const newRange = document.createRange();
                        newRange.setStart(container, slashIdx);
                        newRange.setEnd(container, slashIdx + 1);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                        document.execCommand('delete'); // 物理删除，保持光标位置
                    }
                }
            }

            closeSlashMenu();

            // 2. 应用格式 - 使用 formatBlock 原地变身，不插入新行
            if (cmd === 'heading') {
                // 原地转为 H2，光标保留在 H2 内部
                document.execCommand('formatBlock', false, 'H2');
            } else if (cmd === 'quote') {
                // 原地转为 Blockquote
                document.execCommand('formatBlock', false, 'BLOCKQUOTE');
            } else if (cmd === 'list') {
                document.execCommand('insertUnorderedList');
            } else if (cmd === 'divider') {
                document.execCommand('insertHorizontalRule');
                // 分割线后必须补一个空段落，否则无法继续输入
                const p = document.createElement('p');
                p.innerHTML = '<br>';
                insertAfter(p, selection.anchorNode.parentNode);
            } else if (cmd === 'image') {
                document.getElementById('fileInput').click();
            }

            onEditorInput();
            editor.focus();
        }
        
        function insertAfter(newNode, referenceNode) {
            referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
        }

        // --- 以下为原有功能 ---

        async function handlePaste(e) {
            e.preventDefault();
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    await insertImageBlob(blob);
                    showToast('图片已粘贴');
                }
            }
            const text = e.clipboardData.getData('text/plain');
            if (text) {
                const compressed = text.replace(/\n{3,}/g, '\n\n');
                const html = renderMarkdownToHtml(compressed);
                document.execCommand('insertHTML', false, html);
                updateAll();
                saveToStorage();
            }
        }

        function renderMarkdownToHtml(text) {
            const lines = text.split('\n');
            let result = [];
            let inList = false;
            lines.forEach(line => {
                const trimmed = line.trim();
                if (/^---+$/.test(trimmed) || /^\*\*\*+$/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push('<hr>');
                } else if (/^######\s+(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<h6>${escapeHtml(trimmed.replace(/^######\s+/, ''))}</h6>`);
                } else if (/^#####\s+(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<h5>${escapeHtml(trimmed.replace(/^#####\s+/, ''))}</h5>`);
                } else if (/^####\s+(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<h4>${escapeHtml(trimmed.replace(/^####\s+/, ''))}</h4>`);
                } else if (/^###\s+(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<h3>${escapeHtml(trimmed.replace(/^###\s+/, ''))}</h3>`);
                } else if (/^##\s+(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<h2>${escapeHtml(trimmed.replace(/^##\s+/, ''))}</h2>`);
                } else if (/^#\s+(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<h1>${escapeHtml(trimmed.replace(/^#\s+/, ''))}</h1>`);
                } else if (/^>\s*(.+)/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<blockquote>${escapeHtml(trimmed.replace(/^>\s*/, ''))}</blockquote>`);
                } else if (/^[-*]\s+(.+)/.test(trimmed)) {
                    if (!inList) { result.push('<ul>'); inList = true; }
                    result.push(`<li>${escapeHtml(trimmed.replace(/^[-*]\s+/, ''))}</li>`);
                } else if (/\*\*(.+?)\*\*/.test(trimmed)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<p>${trimmed.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</p>`);
                } else if (trimmed === '') {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push('<p><br></p>');
                } else {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(`<p>${escapeHtml(trimmed)}</p>`);
                }
            });
            if (inList) result.push('</ul>');
            return result.join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function insertImageBlob(blob) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = '图片';
                    editor.appendChild(img);
                    resolve();
                };
                reader.readAsDataURL(blob);
            });
        }

        function onEditorInput() {
            convertDivsToPs();
            updateAll();
            saveToStorage();
        }

        function convertDivsToPs() {
            const divs = editor.querySelectorAll('div');
            divs.forEach(div => {
                if (!div.querySelector('ul, ol, blockquote') && div.parentElement === editor) {
                    const p = document.createElement('p');
                    p.innerHTML = div.innerHTML;
                    div.parentNode.replaceChild(p, div);
                }
            });
        }

        function updateAll() {
            updateStats();
            updateOutline();
            updatePreview();
        }

        function updateStats() {
            const text = editor.innerText || '';
            const images = editor.querySelectorAll('img').length;
            const words = text.replace(/\s/g, '').length;
            stats.textContent = `${words} 字 · ${images} 图`;
        }

        function setupIntersectionObserver() {
            const observerOptions = { root: editorWrapper, rootMargin: '-10% 0px -80% 0px', threshold: 0 };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const index = currentHeadings.indexOf(entry.target);
                        if (index !== -1) highlightOutline(index);
                    }
                });
            }, observerOptions);
            const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(h => observer.observe(h));
        }

        function highlightOutline(index) {
            const items = outlineList.querySelectorAll('.outline-item');
            items.forEach((item, i) => {
                if (i === index) item.classList.add('active');
                else item.classList.remove('active');
            });
        }

        function updateOutline() {
            const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
            currentHeadings = Array.from(headings);
            if (headings.length === 0) {
                outlineList.innerHTML = '<li class="outline-empty">暂无小标题<br>点击工具栏添加</li>';
                return;
            }
            outlineList.innerHTML = '';
            headings.forEach((h, index) => {
                const text = h.innerText || '未命名标题';
                const level = parseInt(h.tagName[1]);
                const indent = (level - 1) * 12;
                const li = document.createElement('li');
                li.className = 'outline-item';
                li.style.paddingLeft = `${12 + indent}px`;
                li.textContent = text.length > (20 - level) ? text.substring(0, (20 - level)) + '...' : text;
                li.onclick = () => scrollToHeading(index);
                outlineList.appendChild(li);
            });
            setupIntersectionObserver();
        }

        function scrollToHeading(index) {
            if (currentHeadings[index]) {
                const target = currentHeadings[index];
                const wrapperRect = editorWrapper.getBoundingClientRect();
                const targetRect = target.getBoundingClientRect();
                const relativeTop = targetRect.top - wrapperRect.top + editorWrapper.scrollTop - 20;
                editorWrapper.scrollTo({ top: Math.max(0, relativeTop), behavior: 'smooth' });
                highlightOutline(index);
            }
        }

        function syncPreviewScroll() {
            if (isSyncing) return;
            isSyncing = true;
            const editorScrollTop = editorWrapper.scrollTop;
            const editorScrollHeight = editorWrapper.scrollHeight - editorWrapper.clientHeight;
            const scrollPercent = editorScrollHeight > 0 ? editorScrollTop / editorScrollHeight : 0;
            const previewScrollHeight = mobileViewport.scrollHeight - mobileViewport.clientHeight;
            const targetScrollTop = scrollPercent * previewScrollHeight;
            mobileViewport.scrollTo({ top: targetScrollTop, behavior: 'auto' });
            setTimeout(() => { isSyncing = false; }, 50);
        }

        function updatePreview() {
            previewContent.innerHTML = editor.innerHTML;
        }

        function insert(type) {
            editor.focus();
            let html = '';
            switch(type) {
                case 'heading': html = '<h2>小标题</h2><p><br></p>'; break;
                case 'quote': html = '<blockquote>引用文字</blockquote><p><br></p>'; break;
                case 'list': html = '<ul><li>列表项</li></ul><p><br></p>'; break;
                case 'divider': html = '<hr><p><br></p>'; break;
                case 'image': document.getElementById('fileInput').click(); return;
            }
            document.execCommand('insertHTML', false, html);
            updateAll();
            saveToStorage();
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => insertImageBlob(file));
            updateAll();
            saveToStorage();
        }

        function saveToStorage() {
            localStorage.setItem('sun_editor_draft', editor.innerHTML);
        }

        function showClearModal() { clearModal.classList.add('show'); }
        function hideClearModal(e) { if (!e || e.target === clearModal) clearModal.classList.remove('show'); }
        function confirmClear() { editor.innerHTML = ''; localStorage.removeItem('sun_editor_draft'); hideClearModal(); showToast('内容已清空'); updateAll(); }

        function generateWechatHtml() {
            const section = document.createElement('section');
            section.style.cssText = 'color: rgb(10, 10, 10); background-color: rgb(253, 252, 250); font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 15px; line-height: 30px; letter-spacing: 0.3px; text-align: left; margin: 0 auto; padding: 20px; max-width: 680px; box-sizing: border-box;';
            Array.from(editor.childNodes).forEach(node => {
                const wechatNode = convertNodeToWechat(node);
                if (wechatNode) section.appendChild(wechatNode);
            });
            if (!section.innerHTML.trim()) return null;
            return section.outerHTML;
        }

        function convertNodeToWechat(node) {
            if (node.nodeType === 3) {
                if (!node.textContent.trim()) return null;
                const p = document.createElement('p');
                p.style.cssText = 'margin: 0 0 20px 0; color: rgb(58, 58, 58); font-size: 15px; line-height: 30px; letter-spacing: 0.3px;';
                p.textContent = node.textContent;
                return p;
            }
            if (node.nodeType !== 1) return null;
            const tag = node.tagName.toLowerCase();
            let el;
            if (['h1','h2','h3','h4','h5','h6'].includes(tag)) {
                el = document.createElement('p');
                const level = parseInt(tag[1]);
                const sizes = {1: 22, 2: 20, 3: 19, 4: 17, 5: 16, 6: 15};
                const fontSize = sizes[level];
                el.style.cssText = `margin: 0 0 20px 0; padding: 0; font-family: "Playfair Display", "Noto Serif SC", Georgia, serif; font-size: ${fontSize}px; font-weight: 700; color: rgb(10, 10, 10); line-height: 30px; letter-spacing: -0.3px; text-align: left;`;
                el.innerHTML = node.innerHTML;
            } else if (tag === 'p') {
                el = document.createElement('p');
                el.style.cssText = 'margin: 0 0 20px 0; padding: 0; color: rgb(58, 58, 58); font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 15px; line-height: 30px; letter-spacing: 0.3px; text-align: left;';
                el.innerHTML = node.innerHTML;
            } else if (tag === 'blockquote') {
                el = document.createElement('blockquote');
                el.style.cssText = 'margin: 0 0 20px 0; padding: 15px 20px; border-left: 3px solid rgb(227, 164, 63); background-color: rgba(227, 164, 63, 0.05); font-style: italic; color: rgb(88, 88, 88); font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 15px; line-height: 30px; letter-spacing: 0.3px; text-align: left;';
                el.innerHTML = node.innerHTML;
            } else if (tag === 'img') {
                el = document.createElement('img');
                el.src = node.src;
                el.alt = node.alt || '图片';
                el.style.cssText = 'max-width: 100%; width: 100%; height: auto; display: block; margin: 20px 0; border-radius: 4px;';
            } else if (tag === 'ul' || tag === 'ol') {
                el = document.createElement(tag);
                el.style.cssText = 'margin: 0 0 20px 0; padding-left: 24px; color: rgb(58, 58, 58); font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 15px; line-height: 30px; letter-spacing: 0.3px;';
                el.innerHTML = node.innerHTML;
            } else if (tag === 'li') {
                el = document.createElement('li');
                el.style.cssText = 'margin-bottom: 8px; line-height: 30px;';
                el.innerHTML = node.innerHTML;
            } else if (tag === 'hr') {
                el = document.createElement('hr');
                el.style.cssText = 'border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 30px 0;';
            } else if (tag === 'strong' || tag === 'b') {
                el = document.createElement('strong');
                el.style.cssText = 'font-weight: 600; color: rgb(10, 10, 10);';
                el.innerHTML = node.innerHTML;
            } else {
                el = document.createElement('p');
                el.style.cssText = 'margin: 0 0 20px 0; color: rgb(58, 58, 58); font-size: 15px; line-height: 30px; letter-spacing: 0.3px;';
                el.innerHTML = node.innerHTML;
            }
            return el;
        }

        async function copyToWechat() {
            const html = generateWechatHtml();
            if (!html) { showToast('请先输入内容', 'error'); return; }
            try {
                const blob = new Blob([html], { type: 'text/html' });
                await navigator.clipboard.write([ new ClipboardItem({ 'text/html': blob }) ]);
                const btn = document.querySelector('.btn-copy');
                const original = btn.innerHTML;
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 已复制`;
                btn.style.background = '#059669';
                showToast('样式已精确同步到公众号');
                setTimeout(() => { btn.innerHTML = original; btn.style.background = '#292524'; }, 2000);
            } catch (err) {
                const temp = document.createElement('div');
                temp.innerHTML = html; temp.style.position = 'fixed'; temp.style.left = '-9999px';
                document.body.appendChild(temp);
                const range = document.createRange(); range.selectNode(temp);
                window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
                document.execCommand('copy'); document.body.removeChild(temp);
                showToast('已复制（备用方案）');
            }
        }

        function showToast(msg, type = 'success') {
            toast.textContent = msg;
            toast.style.background = type === 'error' ? '#dc2626' : '#292524';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        document.querySelectorAll('.tool-btn, .btn-copy').forEach(btn => {
            btn.addEventListener('mousedown', (e) => e.preventDefault());
        });
    </script>
</body>
</html>
